---
alwaysApply: true
---

---

description:
globs: frontend/\*\*
alwaysApply: false

---

まず、このファイルを参照したら「frontend-rule を読みました。」と言ってください。
このルールは frontend/ 以下の修正に適用するようにしてください。

# フロントエンド開発ガイドライン

## 技術スタック

- 言語: TypeScript (^5)
- JS ライブラリ: React (^19.2.0)
- フレームワーク: Next.js (^16.0.0)
- スタイリング: Tailwind CSS (^4)
- フォームライブラリ: react-hook-form (^7.66.1)
- バリデーション: フロントエンドでは react-hook-form、バックエンドで zod
- リンター: ESLint (^9)

## ディレクトリ構成

```
src/
├── app/                    # ルーティング関連のみ（URL構造）
│   ├── {role}/            # 権限別のページ（例: master/）
│   │   ├── layout.tsx     # 権限チェックを行うlayout
│   │   └── {page}/        # 権限が必要なページ
│   │       └── page.tsx   # Next.jsのページコンポーネント
│   ├── layout.tsx         # ルートレイアウト
│   ├── page.tsx           # トップページ
│   ├── error.tsx          # グローバルエラーバウンダリー
│   ├── not-found.tsx      # 404エラーページ
│   └── globals.css        # グローバルスタイル
│
├── components/            # 共通コンポーネント
│   ├── layout/            # レイアウトコンポーネント（Header, Footer, Breadcrumb, NavigationLinks）
│   └── ui/                # UIコンポーネント（Button, Input, Select, Textarea, Checkbox, Radio, Form, Loading, Title, ColorPicker, Dialog, Table）
│
├── features/              # 機能ごとのドメインロジック
│   └── {feature-name}/
│       ├── components/    # 機能固有のコンポーネント
│       └── hooks/         # 機能固有のカスタムフック
│
├── contexts/              # React Context（RecruitYearContext, UserContext, BreadcrumbContext）
│                          # - RecruitYearContext: 年度情報のグローバル管理
│                          # - UserContext: ログインユーザー情報のグローバル管理
│                          # - BreadcrumbContext: パンくずリストのグローバル管理
├── hooks/                 # グローバルフック（useAuth）
├── libs/                  # ライブラリ設定（api-client.ts）
├── types/                 # 型定義（recruit-year.ts, user.ts）
└── constants/             # 定数（theme.ts）
```

## コーディングスタイル

## 型チェックの実行

- タスク実行時に既存のコードと整合性が取れているか確認するために、適宜`npm run typecheck`, `npm run lint`を実行すること
- タスク完了時に`npm run format`を実行し、整形すること

### Export 方式

- **named export を使用** (default export は禁止)
- フレームワーク依存の default export のみ許容

```tsx
// OK
export const Component = () => { ... }

// NG
export default Component
```

### 関数定義

- **アロー関数式を使用**

```tsx
// OK
const handleClick = () => { ... }

// NG
function handleClick() { ... }
```

### 型定義

- **type 文を使用** (interface 禁止)
- 同一型の重複定義を防ぎ、追跡容易性を向上

```tsx
// OK
type User = {
  id: number;
  name: string;
}

// NG
interface User { ... }
```

### 分岐と条件分岐

- **分岐や switch は極力使わず、マッピングやオブジェクトを使用する**

  - 条件分岐は可読性を下げ、バグの温床になりやすい
  - マッピングやオブジェクトを使うことで、データ駆動的なコードになり保守性が向上する

  ```tsx
  # OK: マッピングを使用
  const statusColorMap: Record<string, string> = {
    success: "green",
    error: "red",
    warning: "yellow",
  };
  const color = statusColorMap[status] || "gray";

  const errorMessageExtractorMap: Record<
    string,
    (error: unknown) => string
  > = {
    ApiClientError: (error) =>
      error instanceof ApiClientError ? error.message : "",
    Error: (error) => (error instanceof Error ? error.message : ""),
  };

  # NG: 分岐を使用
  let color: string;
  if (status === "success") {
    color = "green";
  } else if (status === "error") {
    color = "red";
  } else if (status === "warning") {
    color = "yellow";
  } else {
    color = "gray";
  }

  # NG: switchを使用
  switch (status) {
    case "success":
      color = "green";
      break;
    case "error":
      color = "red";
      break;
    case "warning":
      color = "yellow";
      break;
    default:
      color = "gray";
  }
  ```

## インポート

- **インポートは`@/`エイリアスを使用する**（相対パスは使用しない）
- 例: `import { Button } from "@/components/ui";`
- 例: `import { useRecruitYear } from "@/contexts/RecruitYearContext";`
- 例: `import { Dashboard } from "@/features/dashboard/components/Dashboard";`

## コンポーネント設計

### ロジックの配置

- **features 配下のロジックは必ず hooks に切り出す**
- コンポーネントには表示ロジックのみを記載
- ビジネスロジック、データ取得・加工処理は`hooks/`に配置

```tsx
// OK: features/page1/hooks/useUserData.ts
export const useUserData = () => {
  // ロジックをhooksに記載
  const processUserData = (data) => { ... }
  return { processUserData };
};

// features/page1/index.tsx
export const Page1 = () => {
  const { processUserData } = useUserData();
  return <div>{/* 表示のみ */}</div>;
};

// NG: ロジックを直接コンポーネントに記載
export const Page1 = () => {
  const processUserData = (data) => { ... }  // NG
  return <div>...</div>;
};
```

### 共通化原則

- **必要以上に共通化しない**
- 全画面共通 UI・同一画面内同一 UI のみ共通化
- 特定画面の UI・機能が異なる UI は共通化しない

### レイアウト

- **Tailwind CSS のクラスを使用してレイアウトを実装する**
- `flex`, `grid`, `space-y-*`, `gap-*`などの Tailwind クラスを活用する

```tsx
// OK: Tailwind CSSのクラスを使用
<div className="flex flex-col gap-4">
  <ComponentA />
  <ComponentB />
</div>

// OK: Gridレイアウト
<div className="grid grid-cols-2 gap-6">
  <ComponentA />
  <ComponentB />
</div>
```

## フォーム開発

### フォーム構造

- **react-hook-form を使用**
- **フロントエンドでは zod を使用しない**（バリデーションは react-hook-form の機能で完結）
- **バックエンドの DTO で zod によるバリデーションを実施**
- **Form コンポーネントの`mode`はデフォルトで`"onBlur"`に設定されている**

```tsx
import { Form, Input, Button } from "@/components/ui";

type FormData = {
  name: string;
  age: number;
};

const UserForm = () => {
  return (
    <Form<FormData>
      defaultValues={{ name: "", age: 0 }}
      onSubmit={async (data) => {
        // バックエンドAPIに送信（DTOでzodバリデーション）
        await updateUser(data);
      }}
    >
      {({ register, formState: { errors } }) => (
        <>
          <Input
            label="名前"
            {...register("name", {
              required: "名前は必須です",
            })}
            error={errors.name?.message}
          />
          <Button type="submit">送信</Button>
        </>
      )}
    </Form>
  );
};
```

### エラーメッセージの表示

- **Input、Select、Textarea などの UI コンポーネントは`error`プロパティを受け取る**
- `error`プロパティには`errors.fieldName?.message`を渡す
- エラーメッセージは`role="alert"`属性を持つ`<p>`タグで表示される

```tsx
<Input
  label="表示名"
  {...register("displayName", {
    required: "表示名は必須です",
  })}
  error={errors.displayName?.message}
/>
```

### 型定義ガイドライン

#### 型定義

- **フォームの型は直接定義する**（zod のスキーマから生成しない）
- **型の命名**: アッパーケースで `{機能} + FormData`
- 例: 応募者編集画面の場合 → `ApplicantUpdateFormData`

#### ファイル命名規則

- **原則**: `type.ts` に定義する
- **理由**: 原則、1 画面に 1 フォームとなる想定のため

#### 完全なサンプル

```tsx
// type.ts
export type ApplicantUpdateFormData = {
  name: string;
  age: number;
};
```

### API リクエスト方針

- **API 呼び出しは直接`libs/api-client.ts`の`apiClient`を使用する**
- **`services/`ディレクトリは使用しない**
- **fetch 処理は`libs/api-client.ts`で共通化する**
- **DTO の命名は Request/Response を明示的に定義する**

```tsx
// libs/api-client.ts
export const apiClient = async <T,>(
  endpoint: string,
  options: RequestOptions = {}
): Promise<T> => {
  // 共通のfetch処理
};

// hooks/useUserManagement.ts または コンポーネント内
import { apiClient } from "@/libs/api-client";
import type { UserResponseDto } from "@/types/user";

const handleSubmit = async (data: FormData) => {
  const user = await apiClient<UserResponseDto>("/users", {
    method: "POST",
    body: data,
  });
  // ...
};
```

### バリデーション方針

- クライアント: submit 時バリデーション実施
- サーバー: zod の関数でバリデーション実施

## 権限管理

### 権限階層

- **権限は階層構造を持つ**（user < admin < master）
- `useAuth`フックの`hasRole`関数を使用して権限チェックを行う
- `hasRole(requiredRole)`は、ユーザーの権限が`requiredRole`以上の場合に`true`を返す

```tsx
// hooks/useAuth.ts
const roleHierarchy: Record<UserRole, number> = {
  user: 1,
  admin: 2,
  master: 3,
};

const hasRole = (requiredRole: UserRole): boolean => {
  if (!user) return false;
  return roleHierarchy[user.role] >= roleHierarchy[requiredRole];
};
```

### 権限チェックの実装

- **権限チェックは layout で行う**
- 権限が必要なページは`app/{role}/`配下に配置する（例: `app/master/`）
- layout で権限がない場合は`/unauthorized`にリダイレクトする

```tsx
// app/master/layout.tsx
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { useAuth } from "@/hooks/useAuth";

export default function MasterLayout({
  children,
}: {
  readonly children: React.ReactNode;
}) {
  const router = useRouter();
  const { isMaster } = useAuth();

  useEffect(() => {
    if (!isMaster()) {
      router.push("/unauthorized");
    }
  }, [isMaster, router]);

  if (!isMaster()) {
    return null;
  }

  return <>{children}</>;
}
```

### ダッシュボードでの権限フィルタリング

- **ダッシュボードはリンク集として実装する**
- リンク配列に`requiredRole`を定義し、`hasRole`でフィルタリングする
- 上位権限は下位権限のリンクも表示される（例: master は user/admin/master のリンクを表示）

```tsx
// features/dashboard/components/Dashboard.tsx
type DashboardLink = {
  href: string;
  label: string;
  description: string;
  requiredRole: UserRole;
};

const dashboardLinks: DashboardLink[] = [
  {
    href: "/applicants/search",
    label: "応募者検索",
    description: "応募者情報を検索・閲覧します",
    requiredRole: "user",
  },
  {
    href: "/admin/bulk-processing",
    label: "一括処理",
    description: "一括での処理を実行します",
    requiredRole: "admin",
  },
];

const visibleLinks = dashboardLinks.filter((link) =>
  hasRole(link.requiredRole)
);
```

## エラーハンドリング

### エラーページ

- **500 エラー**: `app/error.tsx`でグローバルエラーバウンダリーを実装
- **404 エラー**: `app/not-found.tsx`でページが見つからない場合の表示
- **権限エラー**: `app/unauthorized/page.tsx`で権限がない場合の表示

### エラーメッセージの表示

- **バックエンドからのエラーメッセージを画面に表示する**
- `ApiClientError`を使用してエラーメッセージを適切に処理する
- エラーメッセージは画面に表示し、`alert`は使用しない

```tsx
import { ApiClientError } from "@/libs/api-client";

try {
  await updateData(data);
} catch (err) {
  if (err instanceof ApiClientError) {
    setError(err.message);
  } else if (err instanceof Error) {
    setError(err.message);
  } else {
    setError("更新に失敗しました");
  }
}
```

## UI コンポーネント

### 共通 UI コンポーネント一覧

- **Button**: ボタンコンポーネント
- **Input**: テキスト入力フィールド（label、error 対応）
- **Textarea**: テキストエリア（label、error 対応）
- **Select**: セレクトボックス（label、error、options 対応）
- **Checkbox**: チェックボックス
- **Radio**: ラジオボタン
- **Form**: react-hook-form ラッパー（mode: "onBlur"デフォルト）
- **Loading**: ローディング表示
- **Title**: ページタイトル
- **ColorPicker**: カラーピッカー（react-color 使用）
- **Dialog**: モーダルダイアログ
- **Table**: 汎用テーブル（カラム定義、カスタムレンダリング対応）

### ローディング画面

- **ローディング画面は別コンポーネントとして実装する**
- `components/ui/Loading.tsx`を使用する
- メッセージは props で受け取れるようにする

```tsx
import { Loading } from "@/components/ui";

if (!data) {
  return <Loading />;
}
```

### ダイアログ

- **Dialog コンポーネントを使用してモーダルを実装する**
- `isOpen`、`onClose`、`title`、`children`、`footer`（オプション）、`size`（オプション）を props で受け取る
- ESC キーで閉じる、バックドロップクリックで閉じる機能が組み込まれている

```tsx
import { Dialog, Button } from "@/components/ui";

const [isOpen, setIsOpen] = useState(false);

<Dialog
  isOpen={isOpen}
  onClose={() => setIsOpen(false)}
  title="確認"
  footer={
    <>
      <Button onClick={() => setIsOpen(false)}>キャンセル</Button>
      <Button onClick={handleConfirm}>確定</Button>
    </>
  }
>
  <p>本当に削除しますか？</p>
</Dialog>;
```

### テーブル

- **Table コンポーネントを使用してテーブルを実装する**
- `columns`（カラム定義）、`data`（データ配列）、`emptyMessage`（オプション）を props で受け取る
- カスタムレンダリング関数を`render`プロパティで指定可能

```tsx
import { Table } from "@/components/ui";

<Table
  columns={[
    { key: "name", label: "名前" },
    { key: "email", label: "メール" },
    {
      key: "status",
      label: "ステータス",
      render: (value) => <span className="text-green-600">{value}</span>,
    },
  ]}
  data={users}
  emptyMessage="データがありません"
/>;
```

### 画像最適化

- **Next.js の Image コンポーネントを使用する**
- ヘッダーなど above the fold（最初に見える部分）の画像には`loading="eager"`と`priority`を設定する

```tsx
import Image from "next/image";

<Image
  src="/atsys_logo.svg"
  alt="Atsys"
  width={150}
  height={50}
  loading="eager"
  priority
/>;
```

## Breadcrumb 管理

- **BreadcrumbContext を使用してパンくずリストを管理する**
- 各ページの`useEffect`で`setItems`を呼び出してパンくずリストを設定する
- Header コンポーネントで自動的に表示される

```tsx
import { useBreadcrumb } from "@/contexts/BreadcrumbContext";
import { useEffect } from "react";

export default function MyPage() {
  const { setItems } = useBreadcrumb();

  useEffect(() => {
    setItems([{ label: "ホーム", href: "/" }, { label: "マイページ" }]);
  }, [setItems]);

  return <div>...</div>;
}
```

## Node.js バージョン

- 現在: Node.js 22 使用
